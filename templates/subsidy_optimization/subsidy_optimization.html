<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Subsidy Optimization - {{ data.client_name }}</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', -apple-system, BlinkMacSystemFont, sans-serif;
            font-size: 11px;
            line-height: 1.4;
            color: #1a1a1a;
            background: white;
        }

        .page {
            width: 8.5in;
            min-height: 11in;
            padding: 0.5in;
            background: white;
            display: flex;
            flex-direction: column;
        }

        .content {
            flex: 1;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 3px solid #0D7377;
        }

        .header h1 {
            font-size: 22px;
            font-weight: 700;
            color: #0D7377;
        }

        .header-right {
            text-align: right;
        }

        .header .client-name {
            font-size: 16px;
            color: #666;
            font-weight: 500;
        }

        .header .report-date {
            font-size: 11px;
            color: #999;
        }

        /* Summary Cards Grid */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .summary-card {
            background: white;
            border-radius: 8px;
            padding: 14px 16px;
            text-align: center;
            border: 1px solid #e5e7eb;
        }

        .summary-card--primary {
            background: #e6fffa;
            border-color: #0D7377;
        }

        .summary-card--success {
            background: #f0fdf4;
            border-color: #22c55e;
        }

        .summary-card--accent {
            background: #f0f9ff;
            border-color: #3b82f6;
        }

        .summary-card--teal {
            background: #f0fdfa;
            border-color: #14b8a6;
        }

        .summary-label {
            font-size: 11px;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 6px;
        }

        .summary-value {
            font-size: 28px;
            font-weight: 700;
            color: #1f2937;
        }

        .summary-card--primary .summary-value {
            color: #0D7377;
        }

        .summary-card--success .summary-value {
            color: #16a34a;
        }

        .summary-card--accent .summary-value {
            color: #2563eb;
        }

        .summary-card--teal .summary-value {
            color: #0d9488;
        }

        .summary-sublabel {
            font-size: 10px;
            color: #9ca3af;
            margin-top: 2px;
        }

        /* Strategy Banner */
        .strategy-banner {
            background: linear-gradient(135deg, #f8fffe 0%, #e6fffa 100%);
            border: 1px solid #0D7377;
            border-radius: 8px;
            padding: 12px 18px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .strategy-icon {
            width: 32px;
            height: 32px;
            background: #0D7377;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            flex-shrink: 0;
        }

        .strategy-text {
            flex: 1;
        }

        .strategy-title {
            font-size: 11px;
            font-weight: 600;
            color: #0D7377;
            margin-bottom: 2px;
        }

        .strategy-description {
            font-size: 15px;
            font-weight: 700;
            color: #1f2937;
        }

        /* Employee Table with Multi-Level Headers */
        .employee-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 9px;
            margin-bottom: 16px;
        }

        .employee-table th, .employee-table td {
            padding: 6px 4px;
            text-align: center;
            white-space: normal;
            word-wrap: break-word;
            border-bottom: 1px solid #e5e7eb;
        }

        /* Group Header Row */
        .employee-table .group-header th {
            background: #1f2937;
            color: white;
            font-weight: 600;
            font-size: 8px;
            text-transform: uppercase;
            letter-spacing: 0.03em;
            border-bottom: 2px solid #374151;
            padding: 6px 4px;
        }

        .employee-table .group-header th.group-employee { background: #374151; }
        .employee-table .group-header th.group-afford { background: #0047AB; }
        .employee-table .group-header th.group-subsidy { background: #0d9488; }

        /* Column Header Row */
        .employee-table .col-header th {
            background: #f3f4f6;
            color: #374151;
            font-weight: 600;
            font-size: 8px;
            text-transform: uppercase;
            letter-spacing: 0.03em;
            border-bottom: 2px solid #d1d5db;
            padding: 6px 4px;
            line-height: 1.3;
        }

        .employee-table .col-header th .formula {
            display: block;
            font-size: 6px;
            font-weight: 400;
            color: #6b7280;
            text-transform: none;
            letter-spacing: 0;
            margin-top: 1px;
        }

        .employee-table td {
            font-size: 9px;
            color: #374151;
        }

        .employee-table td.name-cell {
            text-align: left;
            font-weight: 500;
            color: #1f2937;
            max-width: 80px;
        }

        .employee-table tr:nth-child(even) {
            background: #fafafa;
        }

        /* Group borders */
        .employee-table td.group-end, .employee-table th.group-end {
            border-right: 2px solid #d1d5db;
        }

        /* Conditional formatting */
        .fpl-low { background-color: rgba(22, 163, 74, 0.25) !important; color: #15803d; font-weight: 600; }
        .fpl-med { background-color: rgba(234, 179, 8, 0.20) !important; color: #a16207; }
        .fpl-high { background-color: rgba(249, 115, 22, 0.20) !important; color: #c2410c; }
        .fpl-over { color: #9ca3af; }

        .afford-under { background-color: rgba(22, 163, 74, 0.20) !important; color: #15803d; font-weight: 600; }
        .afford-over { background-color: rgba(239, 68, 68, 0.20) !important; color: #dc2626; font-weight: 600; }

        .subsidy-yes { background-color: rgba(13, 148, 136, 0.20) !important; color: #0d9488; font-weight: 600; }

        .cost-better { background-color: rgba(59, 130, 246, 0.15) !important; font-weight: 600; }
        .cost-ptc-better { background-color: rgba(22, 163, 74, 0.15) !important; font-weight: 600; }

        .null-value { color: #9ca3af; }

        /* Legend */
        .legend {
            font-size: 8px;
            color: #6b7280;
            line-height: 1.6;
            margin-top: 12px;
            background: #f9fafb;
            padding: 10px 12px;
            border-radius: 6px;
        }

        .legend-title {
            font-weight: 600;
            color: #374151;
            margin-bottom: 6px;
        }

        .legend-group {
            margin-bottom: 6px;
        }

        .legend-badge {
            display: inline-block;
            padding: 1px 6px;
            border-radius: 3px;
            font-weight: 600;
            font-size: 7px;
            margin-right: 4px;
        }

        .legend-badge--afford { background: #0047AB; color: white; }
        .legend-badge--ptc { background: #0d9488; color: white; }

        .legend-color {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 2px;
            margin-right: 2px;
            vertical-align: middle;
        }

        /* Footer */
        .footer {
            margin-top: auto;
            padding-top: 16px;
            border-top: 1px solid #e5e5e5;
            text-align: center;
        }

        .footer-logo {
            width: 36px;
            height: auto;
            margin-bottom: 6px;
            opacity: 0.8;
        }

        .footer-text {
            font-size: 9px;
            color: #999;
        }

        @media print {
            .page {
                margin: 0;
                padding: 0.4in;
            }
        }
    </style>
</head>
<body>
    <div class="page">
        <div class="content">
        <!-- Header -->
        <div class="header">
            <h1>Subsidy Optimization: {% if data.strategy_type == 'age_curve' %}3:1 Age Curve{% else %}Flat Amount{% endif %}</h1>
            <div class="header-right">
                <span class="client-name">{{ data.client_name }}</span>
                <div class="report-date">{{ data.report_date }}</div>
            </div>
        </div>

        <!-- Strategy Banner -->
        <div class="strategy-banner">
            <div class="strategy-icon">$</div>
            <div class="strategy-text">
                <div class="strategy-title">Contribution Strategy</div>
                <div class="strategy-description">{{ data.strategy_description }}</div>
            </div>
            <div style="text-align: right;">
                <div style="font-size: 11px; color: #6b7280;">Employer Cost</div>
                <div style="font-size: 20px; font-weight: 700; color: #0D7377;">${{ "{:,.0f}".format(data.total_employer_cost) }}/mo</div>
            </div>
        </div>

        <!-- Summary Cards Grid - Row 1 -->
        <div class="summary-grid">
            <div class="summary-card summary-card--primary">
                <div class="summary-label">Total Employees</div>
                <div class="summary-value">{{ data.total_employees }}</div>
                <div class="summary-sublabel">with income data</div>
            </div>
            <div class="summary-card summary-card--success">
                <div class="summary-label">Taking PTC</div>
                <div class="summary-value">{{ data.ptc_count }}</div>
                <div class="summary-sublabel">Premium Tax Credit</div>
            </div>
            <div class="summary-card summary-card--accent">
                <div class="summary-label">Taking ICHRA</div>
                <div class="summary-value">{{ data.ichra_count }}</div>
                <div class="summary-sublabel">employer allowance</div>
            </div>
        </div>

        <!-- Summary Cards Grid - Row 2 -->
        <div class="summary-grid">
            <div class="summary-card summary-card--teal">
                <div class="summary-label">Total Subsidy</div>
                <div class="summary-value">${{ "{:,.0f}".format(data.total_subsidy) }}</div>
                <div class="summary-sublabel">per month</div>
            </div>
            <div class="summary-card">
                <div class="summary-label">Total ER Cost</div>
                <div class="summary-value">${{ "{:,.0f}".format(data.total_employer_cost) }}</div>
                <div class="summary-sublabel">per month</div>
            </div>
            <div class="summary-card">
                <div class="summary-label">Avg Subsidy</div>
                <div class="summary-value">{% if data.ptc_count > 0 %}${{ "{:,.0f}".format(data.total_subsidy / data.ptc_count) }}{% else %}$0{% endif %}</div>
                <div class="summary-sublabel">per PTC taker</div>
            </div>
        </div>

        <!-- Employee Breakdown Table with Multi-Level Headers -->
        <table class="employee-table">
            <thead>
                <!-- Group Header Row - 3 groups for clarity -->
                <tr class="group-header">
                    {% if data.show_slcsp %}
                    <th colspan="6" class="group-employee group-end">Employee</th>
                    {% else %}
                    <th colspan="5" class="group-employee group-end">Employee</th>
                    {% endif %}
                    <th colspan="4" class="group-afford group-end">Affordability Test (EE Cost &le; 9.96% Monthly Income)</th>
                    <th colspan="3" class="group-subsidy">Subsidy Path (if unaffordable)</th>
                </tr>
                <!-- Column Header Row with formula annotations -->
                <tr class="col-header">
                    <th>Name</th>
                    <th>Age</th>
                    <th>Monthly<br>Income</th>
                    <th>LCSP</th>
                    {% if data.show_slcsp %}
                    <th>SLCSP</th>
                    {% endif %}
                    <th class="group-end">FPL %</th>
                    <th>ER Contrib</th>
                    <th>Subsidy Cutoff<span class="formula">Income × 9.96%</span></th>
                    <th>EE Cost<span class="formula">LCSP − ER Contrib</span></th>
                    <th class="group-end">Affordability Gap</th>
                    <th>Expected<br>Premium<span class="formula">Income × 0-8.5%</span></th>
                    <th>Govt<br>Subsidy<span class="formula">SLCSP − Expected</span></th>
                    <th>EE Pays<span class="formula">LCSP − Subsidy</span></th>
                </tr>
            </thead>
            <tbody>
                {% for emp in data.employees %}
                <tr>
                    <!-- Employee group - all input data -->
                    <td class="name-cell">{{ emp.name }}</td>
                    <td>{{ emp.age }}</td>
                    <td style="text-align: right;">${{ "{:,.0f}".format(emp.income) }}</td>
                    <td style="text-align: right;">${{ "{:,.0f}".format(emp.lcsp) }}</td>
                    {% if data.show_slcsp %}
                    <td style="text-align: right;">${{ "{:,.0f}".format(emp.slcsp) }}</td>
                    {% endif %}
                    <!-- FPL % with gradient - end of Employee group -->
                    {% if emp.fpl_pct <= 150 %}
                    <td class="group-end fpl-low" style="text-align: right;">{{ "{:.0f}".format(emp.fpl_pct) }}%</td>
                    {% elif emp.fpl_pct <= 250 %}
                    <td class="group-end fpl-med" style="text-align: right;">{{ "{:.0f}".format(emp.fpl_pct) }}%</td>
                    {% elif emp.fpl_pct < 400 %}
                    <td class="group-end fpl-high" style="text-align: right;">{{ "{:.0f}".format(emp.fpl_pct) }}%</td>
                    {% else %}
                    <td class="group-end fpl-over" style="text-align: right;">{{ "{:.0f}".format(emp.fpl_pct) }}%</td>
                    {% endif %}
                    <!-- Affordability Test group -->
                    <td style="text-align: right;">${{ "{:,.0f}".format(emp.contribution) }}</td>
                    <!-- Threshold -->
                    <td style="text-align: right; color: #6b7280;">${{ "{:,.0f}".format(emp.afford_threshold) }}</td>
                    <!-- EE Cost - highlight if better than EE Pays -->
                    {% if emp.ee_pays is none or emp.ee_cost <= emp.ee_pays %}
                    <td class="cost-better" style="text-align: right;">${{ "{:,.0f}".format(emp.ee_cost) }}</td>
                    {% else %}
                    <td style="text-align: right;">${{ "{:,.0f}".format(emp.ee_cost) }}</td>
                    {% endif %}
                    <!-- Affordability Gap column - shows delta "$X under" or "$X over" -->
                    {% if emp.is_affordable %}
                    <td class="group-end afford-under">{{ emp.affordability_display }}</td>
                    {% else %}
                    <td class="group-end afford-over">{{ emp.affordability_display }}</td>
                    {% endif %}
                    <!-- Subsidy Path group -->
                    <td style="text-align: right;">${{ "{:,.0f}".format(emp.expected_ee_contrib) }}</td>
                    {% if emp.subsidy is not none %}
                    <td class="subsidy-yes" style="text-align: right;">${{ "{:,.0f}".format(emp.subsidy) }}</td>
                    <!-- EE Pays - highlight if better than EE Cost -->
                    {% if emp.ee_pays < emp.ee_cost %}
                    <td class="cost-ptc-better" style="text-align: right;">${{ "{:,.0f}".format(emp.ee_pays) }}</td>
                    {% else %}
                    <td style="text-align: right;">${{ "{:,.0f}".format(emp.ee_pays) }}</td>
                    {% endif %}
                    {% else %}
                    <td class="null-value" style="text-align: center;">-</td>
                    <td class="null-value" style="text-align: center;">-</td>
                    {% endif %}
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <!-- Legend -->
        <div class="legend">
            <div class="legend-title">Calculated Columns (No Black Boxes)</div>
            <div class="legend-group">
                <span class="legend-badge legend-badge--afford">AFFORDABILITY TEST</span>
                <strong>Subsidy Cutoff</strong> = Monthly Income × 9.96% &nbsp;|&nbsp;
                <strong>EE Cost</strong> = LCSP − ER Contrib &nbsp;|&nbsp;
                <strong>Affordability Gap</strong> = "under" if EE Cost ≤ Subsidy Cutoff, "over" if EE Cost > Subsidy Cutoff
            </div>
            <div class="legend-group">
                <span class="legend-badge legend-badge--ptc">SUBSIDY PATH</span>
                Only populated if ICHRA is unaffordable (Affordability Gap = "over").
                <strong>Expected Premium</strong> = Monthly Income × (0% to 8.5%) based on FPL sliding scale &nbsp;|&nbsp;
                <strong>Govt Subsidy</strong> = SLCSP − Expected Premium &nbsp;|&nbsp;
                <strong>EE Pays</strong> = LCSP − Govt Subsidy
            </div>
            <div style="margin-top: 6px; padding-top: 6px; border-top: 1px solid #e5e7eb;">
                <strong>ACA Sliding Scale:</strong>
                100-150% FPL → 0-4% | 150-200% FPL → 4-6.5% | 200-250% FPL → 6.5-8.5% | 250-400% FPL → 8.5%
            </div>
            <div style="margin-top: 6px; padding-top: 6px; border-top: 1px solid #e5e7eb;">
                <strong>Color coding:</strong>
                <span class="legend-color" style="background: rgba(22, 163, 74, 0.25);"></span>FPL ≤150%
                <span class="legend-color" style="background: rgba(234, 179, 8, 0.20); margin-left: 6px;"></span>FPL 150-250%
                <span class="legend-color" style="background: rgba(249, 115, 22, 0.20); margin-left: 6px;"></span>FPL 250-400%
                <span style="margin-left: 6px; color: #9ca3af;">Gray = ≥400% (no subsidy)</span>
                <span class="legend-color" style="background: rgba(59, 130, 246, 0.15); margin-left: 10px;"></span>ICHRA wins
                <span class="legend-color" style="background: rgba(22, 163, 74, 0.15); margin-left: 6px;"></span>Subsidy wins
            </div>
        </div>
        </div><!-- end content -->

        <!-- Footer -->
        <div class="footer">
            {% if data.logo_base64 %}
            <img src="data:image/png;base64,{{ data.logo_base64 }}" alt="Glove" class="footer-logo">
            {% endif %}
            <div class="footer-text">Generated by Glove Benefits{% if data.client_name %} for {{ data.client_name }}{% endif %} | {{ data.report_date }}</div>
        </div>
    </div>
</body>
</html>
